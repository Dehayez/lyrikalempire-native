const CACHE_NAME="lyrikal-empire-v2",AUDIO_CACHE_NAME="lyrikal-empire-audio-v1",MAX_AUDIO_CACHE_SIZE=50,ESSENTIAL_ASSETS=["/","/index.html","/manifest.json","/android-chrome-192x192.png","/android-chrome-512x512.png","/placeholder.png"];async function limitAudioCacheSize(e){try{const t=await e.keys();if(t.length>=50){const a=t.slice(0,t.length-50+1);await Promise.all(a.map((t=>e.delete(t))))}}catch(e){}}async function handleBackgroundAudio(e){(await self.clients.matchAll({type:"window"})).forEach((t=>{t.postMessage({type:"BACKGROUND_AUDIO_PLAY",data:e})}))}async function pauseBackgroundAudio(){(await self.clients.matchAll({type:"window"})).forEach((e=>{e.postMessage({type:"BACKGROUND_AUDIO_PAUSE"})}))}async function skipTrack(e){(await self.clients.matchAll({type:"window"})).forEach((t=>{t.postMessage({type:"BACKGROUND_SKIP_TRACK",direction:e})}))}async function syncAudioQueue(){(await self.clients.matchAll({type:"window"})).forEach((e=>{e.postMessage({type:"SYNC_AUDIO_QUEUE"})}))}self.addEventListener("install",(e=>{e.waitUntil(caches.open(CACHE_NAME).then((async e=>{await Promise.allSettled(ESSENTIAL_ASSETS.map((t=>e.add(t).catch((()=>{})))))})).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(e=>{e.waitUntil(Promise.all([caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME&&e!==AUDIO_CACHE_NAME)return caches.delete(e)}))))),self.clients.claim()]))})),self.addEventListener("fetch",(e=>{const{request:t}=e,a=new URL(t.url),n=a.pathname.includes("/audio/")||a.pathname.endsWith(".mp3")||a.pathname.endsWith(".aac"),i=a.origin!==self.location.origin,c=t.headers&&t.headers.has&&t.headers.has("range");n&&i||c||("navigate"!==t.mode?t.url.includes("/audio/")||t.url.includes(".mp3")||t.url.includes(".aac")?e.respondWith(caches.open(AUDIO_CACHE_NAME).then((e=>e.match(t).then((a=>a||fetch(t).then((a=>(a.ok&&200===a.status&&limitAudioCacheSize(e).then((()=>{e.put(t,a.clone())})),a)))))))):e.respondWith(caches.match(t).then((e=>e||(t.url.includes("placeholder.png")||t.url.includes(".png")||t.url.includes(".jpg")||t.url.includes(".jpeg")||t.url.includes(".gif")||t.url.includes(".webp")?fetch(t).then((e=>{if(e.ok){const a=e.clone();caches.open(CACHE_NAME).then((e=>{e.put(t,a)}))}return e})):fetch(t))))):e.respondWith(fetch(t).then((e=>{if(e.ok){const a=e.clone();caches.open(CACHE_NAME).then((e=>{e.put(t,a)}))}return e})).catch((()=>caches.match("/index.html").then((e=>e||caches.match("/")))))))})),self.addEventListener("message",(e=>{const{type:t,data:a}=e.data;switch(t){case"PLAY_AUDIO":handleBackgroundAudio(a);break;case"PAUSE_AUDIO":pauseBackgroundAudio();break;case"SKIP_TRACK":skipTrack(a.direction)}})),self.addEventListener("sync",(e=>{"background-audio-sync"===e.tag&&e.waitUntil(syncAudioQueue())})),self.addEventListener("push",(e=>{if(e.data){const t=e.data.json();"audio-control"===t.type&&e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:"/android-chrome-192x192.png",badge:"/android-chrome-192x192.png",actions:[{action:"play",title:"Play"},{action:"pause",title:"Pause"},{action:"next",title:"Next"}],tag:"audio-control",renotify:!0,silent:!0}))}})),self.addEventListener("notificationclick",(e=>{e.notification.close(),"play"===e.action?clients.matchAll({type:"window"}).then((e=>{e.forEach((e=>{e.postMessage({type:"PLAY_FROM_NOTIFICATION"})}))})):"pause"===e.action?clients.matchAll({type:"window"}).then((e=>{e.forEach((e=>{e.postMessage({type:"PAUSE_FROM_NOTIFICATION"})}))})):"next"===e.action?clients.matchAll({type:"window"}).then((e=>{e.forEach((e=>{e.postMessage({type:"NEXT_FROM_NOTIFICATION"})}))})):clients.openWindow("/")}));