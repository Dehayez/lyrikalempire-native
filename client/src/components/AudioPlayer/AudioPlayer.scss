@use 'sass:math';
@import '../../globals/variables';

$indicator-size: 14px;
$indicator-half-size: math.div($indicator-size, 2);

// Loading animation mixin
@mixin loading-shimmer-animation {
  .rhap_progress-bar {
    transition: background 0.3s ease;
  }
  
  &.loading .rhap_progress-bar,
  &.loading .rhap_progress-container .rhap_progress-bar {
    background-color: $color-gray-mid !important;
    background-image: linear-gradient(90deg, 
      $color-gray-mid 0%,
      $color-gray-mid 25%,
      lighten($color-gray-mid, 25%) 50%,
      $color-gray-mid 75%,
      $color-gray-mid 100%
    ) !important;
    background-size: 200% 100% !important;
    background-repeat: no-repeat !important;
    animation: loading-shimmer 3s linear infinite !important;
  }
}

:root {
  --indicator-size: #{$indicator-size};
  --indicator-half-size: #{$indicator-half-size};
}

// Hide native audio controls but keep them accessible for background playback
audio::-webkit-media-controls {
  display: none !important;
}

audio::-webkit-media-controls-enclosure {
  display: none !important;
}

audio {
  &[controls] {
    position: absolute;
    z-index: -1;
    opacity: 0;
    pointer-events: none;
  }
}

.audio-player {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
  transition: bottom 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
  box-sizing: border-box;
  background-color: $color-black;
  padding: 0 20px;

  &::before {
    content: '';
    position: absolute;
    top: -45px;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(to top, $color-black 0%, transparent 100%);
    pointer-events: none;
    opacity: var(--scroll-opacity-bottom, 0);
    transition: opacity 0.1s ease;
    z-index: 0;
  }

  &--desktop {
    // Loading animation
    @include loading-shimmer-animation;
    
    .rhap_progress-section {
      padding: 40px 0;
    } 
  }

  &--lyrics-modal-open {
    position: absolute;
    z-index: 11;
    bottom: 40px;

    @media (display-mode: standalone) {
      bottom: 76px;
    }
  }

  .icon-primary {
    color: $color-primary;
  }

  .rhap_current-time,
  .rhap_total-time {
    width: 40px;
  }

  .rhap_progress-container {
    position: relative;
    touch-action: none;
  }

  .waveform {
    position: absolute;
    top: -30px;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity .3s ease;

    &--active {
      opacity: .4 !important;
    }
  }

  &__text {
    width: 100%;
    display: grid;
    gap: 4px;
    padding: 8px 0;

    &--desktop {
      font-size: 16px;
    }
  }

  &__title {
    margin: 0;
    padding: 0;
    font-weight: 600;
    font-size: 15px;
  }

  &__artist {
    margin: 0;
    padding: 0;
    font-size: 14px;
  }

  &__settings {
    display: flex;
    padding-left: 20px;
  }

  &__full-page {
    // progress indicator styling similar to mobile
    .rhap_progress-indicator {
      opacity: 0 !important;
      transform: scale(3) !important;
      transition: opacity 0.4s ease;
    }

    .rhap_progress-dragging {
      .rhap_progress-indicator {
        opacity: 1 !important;
        transform: scale(1) !important;
        transition: opacity 0.4s ease, transform 0s !important;
      }
    }

    // Loading animation
    @include loading-shimmer-animation;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    padding: 8px 16px 0 16px;
    background-color: $color-black;

    @media (display-mode: standalone) {
      padding-bottom: 36px;
    }
    z-index: 6;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    transform: translateY(100%); // Start off-screen for slide animation
    will-change: transform; // Optimize for animations

     .rhap_progress-section {
      padding: 28px 0;
    }

    &-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: $overlay;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none; // Disable interactions when hidden

      &.visible {
        opacity: 1;
        pointer-events: auto; // Enable when active
      }
    }

    &-title {
      font-weight: 700;
    }

    & .icon-button--mobile {
      margin: 0;
    }

    &-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    &-controls {
      width: 100%;

      & .audio-player__title {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        margin-bottom: 8px;
      }
      & .audio-player__artist {
        font-size: 14px;
        opacity: 0.8;
        margin: 0;
      }
    }

    &-info {
      display: flex;
      justify-content: space-between;
      margin: 16px 0;
    }

    & .rhap_controls-section {
      padding: 0;
      width: 100%;
      margin: 0;
      margin-bottom: 16px;
    }
  }

  // Mobile components
  &--mobile {
    display: flex;
    justify-content: space-between;
    align-items: center;

    .audio-player__text {
      padding: 8px 0;
      flex: 1;
      min-width: 0;
    }

    .audio-player__controls {
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1;
    }

    .icon-button.play-pause {
      background-color: $color-black;
      padding: 0 20px;
      z-index: 1;
    }

    .icon-button--prev,
    .icon-button--next {
      background-color: transparent;
      padding: 4px;
      color: $color-white;
    }

    .rhap_container {
      background-color: transparent;
    }

    .rhap_progress-bar {
      border-radius: 0;
      height: 6px;
    }

    // Loading animation
    @include loading-shimmer-animation;

    .rhap_progress-indicator {
       opacity: 0 !important;
       transform: scale(3) !important;  
       transition: opacity 0.4s ease, transform 0.4s ease 0.25s !important; 
     }

    .rhap_progress-dragging {
      .rhap_progress-indicator {
        opacity: 1 !important;
        transform: scale(1) !important;
        transition: opacity 0.4s ease, transform 0s !important; 
      }
    }

    .rhap_controls-section,
    .rhap_current-time,
    .rhap_time {
      display: none;
    }
  }

  &__text {
    font-size: 14px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }

  &__title-row {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 0; 
  }

  &__title--scrollable {
    cursor: pointer;
  }

  &__title {
    font-weight: 600;
    color: $color-white;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
  }

  &__artist {
    color: $color-gray-light;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }


}

// Ensure main player is accessible to system media controls
.audio-player__main-player {
  &[style*="display: none"] {
    display: block !important;
    position: absolute;
    opacity: 0.001; // Nearly invisible but still active
    pointer-events: none;
    height: 1px;
    width: 1px;
    overflow: hidden;
    clip: rect(0 0 0 0);
    clip-path: inset(50%);
    white-space: nowrap;
  }
}

.smooth-progress-bar--mobile {
  position: absolute;
  top: -12px;
  left: 0;
  width: 100vw;
  padding: 0;

  .rhap_progress-container {
    margin: 0;
    z-index: 3;

    .rhap_progress-indicator {
      opacity: 1;
    }

    // Mobile waveform - shown only when dragging
    .waveform {
      position: absolute;
      top: -20px;
      left: 0;
      width: 100%;
      height: 60px;
      z-index: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    &.rhap_progress-dragging {
      .waveform {
        opacity: 0.5;
      }
    }
  }
}

.rhap_container {
  background-color: transparent;
  box-shadow: none;
  padding: 0;
}

.rhap_download-progress {
  background-color: transparent;
}

.rhap_progress-bar {
  background-color: $color-gray-mid;
  z-index: 1;
  
  // Ensure shimmer animation works when loading class is present
  .audio-player.loading &,
  .audio-player--mobile.loading &,
  .audio-player--desktop.loading &,
  .audio-player__full-page.loading & {
    background-color: $color-gray-mid !important;
    background-image: linear-gradient(90deg, 
      $color-gray-mid 0%,
      $color-gray-mid 25%,
      lighten($color-gray-mid, 25%) 50%,
      $color-gray-mid 75%,
      $color-gray-mid 100%
    ) !important;
    background-size: 200% 100% !important;
    background-repeat: no-repeat !important;
    animation: loading-shimmer 3s linear infinite !important;
  }
}

.rhap_progress-indicator {
  opacity: 0;
  background-color: white;
  transition: opacity 0.3s ease, transform 0.2s ease;
  width: $indicator-size;
  height: $indicator-size;
  top: calc(50% - #{$indicator-half-size});
  margin-left: -8px;
}

.rhap_time,
.rhap_additional-controls,
.rhap_controls-section {
  color: #FFFFFF;
}

.rhap_progress-filled {
  background: #FFFFFF;
}

.rhap_progress-container {
  position: relative;
  touch-action: none;
  cursor: pointer; // Show pointer cursor for seeking

  .waveform {
    opacity: 0;
    transition: opacity .3s ease;
  }
}

// Desktop-only behavior for progress indicator
.audio-player--desktop {
  // Loading animation
  @include loading-shimmer-animation;
  
  .rhap_progress-container {
    // Hide indicator by default on desktop
    .rhap_progress-indicator {
      opacity: 0 !important;
      transition: opacity 0.3s ease, transform 0.2s ease !important;
    }

    &:hover {
      .rhap_progress-filled {
        background: #FFCC44 !important;
      }
      
      .rhap_progress-indicator {
        opacity: 1 !important;
        transform: scale(1.2);
      }

      .waveform:not(.waveform--active) {
        opacity: .3;
      }
    }
    
    // Show indicator and yellow progress bar while dragging on desktop
    &.rhap_progress-dragging {
      cursor: grabbing;
      
      .rhap_progress-filled {
        background: #FFCC44 !important;
      }
      
      .rhap_progress-indicator {
        opacity: 1 !important;
        transform: scale(1.3);
      }
      
      .waveform:not(.waveform--active) {
        opacity: .4;
      }
    }
    
    // Improve seeking experience on desktop  
    &:active {
      .rhap_progress-indicator {
        opacity: 1 !important;
        transform: scale(1.3);
      }
      
      .waveform:not(.waveform--active) {
        opacity: .35;
      }
    }

    // Ensure indicator is hidden when not hovering and not dragging
    &:not(:hover):not(.rhap_progress-dragging):not(:active) {
      .rhap_progress-indicator {
        opacity: 0 !important;
      }
    }
  }
}

.rhap_progress-indicator,
.rhap_progress-filled,
.rhap_controls-section,
.rhap_play-pause-button {
  color: #FFFFFF !important;
}

.rhap_controls-section {
  width: fit-content;
  margin: auto;
  padding: 8px;
}

@media (max-width: 580px) {
  .audio-player__title--desktop {
    display: none;
  }
  .volume-slider {
    display: none;
  }
}

.audio-player__full-page-controls {
  position: relative;

  .waveform {
    position: absolute;
    top: -30px;
    left: 0;
    width: 100%;
    height: 80px;
    z-index: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;

    &--active {
      opacity: 0.4;
    }
  }
  
  // Add hover effects for full-page player
  .rhap_progress-container {
    &:hover {
      .waveform:not(.waveform--active) {
        opacity: .3;
      }
    }
    
    &.rhap_progress-dragging {
      .waveform:not(.waveform--active) {
        opacity: .4;
      }
    }
    
    &:active {
      .waveform:not(.waveform--active) {
        opacity: .35;
      }
    }
  }
}

.audio-player__edit-panel-content {
  flex: 1;
  width: 100%;
  overflow-y: auto;
  padding: 20px 0;
}

// Loading animation keyframes
@keyframes loading-shimmer {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

// Ensure shimmer animation works with proper base color
.audio-player.loading .rhap_progress-bar {
  background-color: $color-gray-mid !important;
  background-image: linear-gradient(90deg, 
    $color-gray-mid 0%,
    $color-gray-mid 25%,
    lighten($color-gray-mid, 25%) 50%,
    $color-gray-mid 75%,
    $color-gray-mid 100%
  ) !important;
  background-size: 200% 100% !important;
  background-repeat: no-repeat !important;
  animation: loading-shimmer 3s linear infinite !important;
}